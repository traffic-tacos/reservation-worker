---
description: Infrastructure as Code (IaC) ë° í´ë¼ìš°ë“œ ì¸í”„ë¼ êµ¬ì„± ê°€ì´ë“œ
alwaysApply: true
---

# Infrastructure as Code (IaC) êµ¬ì„±

## ğŸ¯ IaC ëª©í‘œ
Traffic Tacos í”„ë¡œì íŠ¸ì˜ AWS ì¸í”„ë¼ë¥¼ Terraformìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ì™„ì „ ìë™í™”ëœ IaC ì‹œìŠ¤í…œ

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ì„¤ê³„

### ë„¤íŠ¸ì›Œí¬ í† í´ë¡œì§€
```
VPC (10.180.0.0/20)
â”œâ”€â”€ Public Tier (10.180.0.0/26, 10.180.0.64/26)
â”‚   â”œâ”€â”€ ALB/NLB (ì™¸ë¶€ íŠ¸ë˜í”½ ì§„ì…)
â”‚   â”œâ”€â”€ Bastion Host (ê´€ë¦¬ìš©)
â”‚   â””â”€â”€ NAT Gateway (Private ì•„ì›ƒë°”ìš´ë“œ)
â”‚
â”œâ”€â”€ Private App Tier (10.180.1.0/25, 10.180.1.128/25)
â”‚   â”œâ”€â”€ EKS ë…¸ë“œ ê·¸ë£¹
â”‚   â”œâ”€â”€ API Gateway íŒŒë“œ
â”‚   â””â”€â”€ Application íŒŒë“œë“¤
â”‚
â””â”€â”€ Private DB Tier (10.180.2.0/26, 10.180.2.64/26)
    â”œâ”€â”€ RDS Aurora (ë°ì´í„°ë² ì´ìŠ¤)
    â”œâ”€â”€ ElastiCache Redis (ìºì‹œ)
    â””â”€â”€ DynamoDB VPC ì—”ë“œí¬ì¸íŠ¸
```

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
terraform/
â”œâ”€â”€ main.tf                    # ë©”ì¸ ë¦¬ì†ŒìŠ¤ ì •ì˜
â”œâ”€â”€ providers.tf              # í”„ë¡œë°”ì´ë” ì„¤ì •
â”œâ”€â”€ backend.tf                # S3 ë°±ì—”ë“œ ì„¤ì •
â”œâ”€â”€ variables.tf              # ì…ë ¥ ë³€ìˆ˜
â”œâ”€â”€ outputs.tf                # ì¶œë ¥ ê°’
â”œâ”€â”€ terraform.tfvars         # ë³€ìˆ˜ ê°’ (í™˜ê²½ë³„)
â””â”€â”€ modules/
    â”œâ”€â”€ vpc/                  # VPC ë„¤íŠ¸ì›Œí¬ ëª¨ë“ˆ
    â”‚   â”œâ”€â”€ main.tf          # VPC, ì„œë¸Œë„·, ë¼ìš°íŒ…
    â”‚   â”œâ”€â”€ variables.tf     # VPC ì„¤ì • ë³€ìˆ˜
    â”‚   â”œâ”€â”€ outputs.tf       # VPC ì¶œë ¥ ê°’
    â”‚   â””â”€â”€ README.md        # ëª¨ë“ˆ ì„¤ëª…
    â”œâ”€â”€ eks/                  # EKS í´ëŸ¬ìŠ¤í„° ëª¨ë“ˆ
    â”œâ”€â”€ rds/                  # RDS ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë“ˆ
    â””â”€â”€ security/             # ë³´ì•ˆ ê·¸ë£¹ ëª¨ë“ˆ
```

## ğŸ”§ ì£¼ìš” ë¦¬ì†ŒìŠ¤ êµ¬ì„±

### VPC ëª¨ë“ˆ (`modules/vpc/`)
```hcl
# ì…ë ¥ ë³€ìˆ˜
variable "vpc_cidr" {
  description = "VPC CIDR ë¸”ë¡"
  type        = string
  default     = "10.180.0.0/20"
}

variable "azs" {
  description = "ê°€ìš© ì˜ì—­ ëª©ë¡"
  type        = list(string)
  default     = ["ap-northeast-2a", "ap-northeast-2c"]
}

# ì¶œë ¥ ê°’
output "vpc_id" {
  description = "VPC ID"
  value       = aws_vpc.main.id
}

output "public_subnet_ids" {
  description = "Public ì„œë¸Œë„· ID ëª©ë¡"
  value       = aws_subnet.public[*].id
}
```

### EKS í´ëŸ¬ìŠ¤í„° êµ¬ì„±
- **ë²„ì „**: 1.28+
- **ë…¸ë“œ ê·¸ë£¹**: ê´€ë¦¬í˜• ë…¸ë“œ ê·¸ë£¹
- **ì¸ìŠ¤í„´ìŠ¤ íƒ€ì…**: m6g.large (Graviton2, ARM64)
- **AutoScaling**: Karpenter ê¸°ë°˜
- **ë„¤íŠ¸ì›Œí‚¹**: Calico CNI

### ë³´ì•ˆ ê·¸ë£¹ ì „ëµ
```hcl
# ALB ë³´ì•ˆ ê·¸ë£¹
resource "aws_security_group" "alb" {
  name_prefix = "traffic-tacos-alb"
  vpc_id      = aws_vpc.main.id

  ingress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }

  ingress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
  }
}
```

## ğŸš€ ë°°í¬ ì›Œí¬í”Œë¡œìš°

### 1. ì´ˆê¸°í™”
```bash
# Terraform ì´ˆê¸°í™”
terraform init

# ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„±
terraform workspace select dev || terraform workspace new dev
```

### 2. ê³„íš ë° ê²€ì¦
```bash
# ë³€ê²½ì‚¬í•­ ê³„íš
terraform plan -var-file="dev.tfvars"

# ì½”ë“œ í¬ë§·íŒ…
terraform fmt -recursive

# ìœ íš¨ì„± ê²€ì¦
terraform validate
```

### 3. ë°°í¬
```bash
# ì¸í”„ë¼ ë°°í¬
terraform apply -var-file="dev.tfvars"

# ì¶œë ¥ ê°’ í™•ì¸
terraform output
```

### 4. ì •ë¦¬
```bash
# ì¸í”„ë¼ ì œê±° (ì£¼ì˜!)
terraform destroy -var-file="dev.tfvars"
```

## ğŸ”’ ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ
- **Private ì„œë¸Œë„·**: ì¸í„°ë„· ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€
- **NAT Gateway**: ì•„ì›ƒë°”ìš´ë“œ íŠ¸ë˜í”½ë§Œ í—ˆìš©
- **Security Group**: ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš©
- **VPC ì—”ë“œí¬ì¸íŠ¸**: AWS ì„œë¹„ìŠ¤ í”„ë¼ì´ë¹— ì—°ê²°

### IAM ì •ì±…
```hcl
# IRSA ì •ì±… ì˜ˆì‹œ
data "aws_iam_policy_document" "gateway_api" {
  statement {
    actions = [
      "dynamodb:GetItem",
      "dynamodb:PutItem",
      "dynamodb:UpdateItem",
      "dynamodb:Query"
    ]
    resources = [
      aws_dynamodb_table.reservations.arn,
      aws_dynamodb_table.orders.arn
    ]
  }
}
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### CloudWatch êµ¬ì„±
- **VPC Flow Logs**: ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ë¡œê¹…
- **CloudTrail**: API í˜¸ì¶œ ê°ì‚¬
- **X-Ray**: ì• í”Œë¦¬ì¼€ì´ì…˜ ì¶”ì 

### ë¹„ìš© ëª¨ë‹ˆí„°ë§
- **Cost Allocation Tags**: ë¦¬ì†ŒìŠ¤ë³„ ë¹„ìš© ì¶”ì 
- **Budgets**: ì˜ˆì‚° ì•Œë¦¼ ì„¤ì •
- **RI/SP Coverage**: ì˜ˆì•½ ì¸ìŠ¤í„´ìŠ¤ ìµœì í™”

## ğŸ§ª í…ŒìŠ¤íŠ¸ ì „ëµ

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```hcl
# Terratest ì˜ˆì‹œ
func TestVpcCreation(t *testing.T) {
  terraformOptions := &terraform.Options{
    TerraformDir: "../examples/vpc",
  }

  defer terraform.Destroy(t, terraformOptions)
  terraform.InitAndApply(t, terraformOptions)

  vpcId := terraform.Output(t, terraformOptions, "vpc_id")
  assert.NotEmpty(t, vpcId)
}
```

### í†µí•© í…ŒìŠ¤íŠ¸
- **Kitchen-Terraform**: IaC í†µí•© í…ŒìŠ¤íŠ¸
- **AWS Config Rules**: ì¸í”„ë¼ ì»´í”Œë¼ì´ì–¸ìŠ¤ ê²€ì¦
- **Prowler**: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”

## ğŸ”„ CI/CD íŒŒì´í”„ë¼ì¸

### GitHub Actions ì›Œí¬í”Œë¡œìš°
```yaml
name: 'IaC CI/CD'
on:
  push:
    branches: [main]
    paths: ['terraform/**']

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform fmt -check
      - run: terraform validate

  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform plan

  apply:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform apply -auto-approve
```

## ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸

### í•„ìˆ˜ êµ¬ì„± ìš”ì†Œ
- [ ] VPC ë° ì„œë¸Œë„· ìƒì„±
- [ ] ì¸í„°ë„· ê²Œì´íŠ¸ì›¨ì´ ë° NAT ê²Œì´íŠ¸ì›¨ì´
- [ ] ë³´ì•ˆ ê·¸ë£¹ ë° ë„¤íŠ¸ì›Œí¬ ACL
- [ ] EKS í´ëŸ¬ìŠ¤í„° ë° ë…¸ë“œ ê·¸ë£¹
- [ ] RDS Aurora í´ëŸ¬ìŠ¤í„°
- [ ] ElastiCache Redis í´ëŸ¬ìŠ¤í„°
- [ ] S3 ë°±ì—”ë“œ ë° ì ê¸ˆ í…Œì´ë¸”

### ë³´ì•ˆ ê°•í™”
- [ ] IRSA ì„¤ì • ë° IAM ì—­í• 
- [ ] VPC ì—”ë“œí¬ì¸íŠ¸ êµ¬ì„±
- [ ] CloudTrail ë° Config í™œì„±í™”
- [ ] ë³´ì•ˆ ê·¸ë£¹ ìµœì†Œ ê¶Œí•œ ì ìš©

### ëª¨ë‹ˆí„°ë§
- [ ] CloudWatch ëŒ€ì‹œë³´ë“œ
- [ ] VPC Flow Logs ì„¤ì •
- [ ] Cost Allocation Tags

### ê³ ê°€ìš©ì„±
- [ ] Multi-AZ ë°°í¬
- [ ] AutoScaling ê·¸ë£¹
- [ ] ë°±ì—… ë° ë³µêµ¬ ì „ëµ

---

*ì´ ë¬¸ì„œëŠ” Traffic Tacos í”„ë¡œì íŠ¸ì˜ IaC êµ¬ì„± ë° ë°°í¬ ê°€ì´ë“œì…ë‹ˆë‹¤.*