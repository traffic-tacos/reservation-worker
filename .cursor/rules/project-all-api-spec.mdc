---
description: ì„œë¹„ìŠ¤ ê°„ API ê³„ì•½ ë° ì¸í„°í˜ì´ìŠ¤ ì •ì˜
globs:
alwaysApply: true
---

# API ê³„ì•½ ë° ì¸í„°í˜ì´ìŠ¤ ì •ì˜

## ğŸ¯ ì„¤ê³„ ì›ì¹™

**30k RPS í­ì£¼ ì‹œë‚˜ë¦¬ì˜¤ ê¸°ë°˜ ê³„ì•½ ì¤‘ì‹¬ API ì„¤ê³„**
- ìœ ì… 30k RPS â†’ ëŒ€ê¸°ì—´ì—ì„œ í‰íƒ„í™” â†’ ì…ì¥ ì œì–´ â†’ í•µì‹¬ ê²½ë¡œ ìµœì í™” â†’ ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬

## ğŸ” ê³µí†µ ê·œì•½

### ì¸ì¦ ë° ê¶Œí•œ
```http
Authorization: Bearer <JWT>
```
- ì¼ë¶€ ê³µê°œ ì—”ë“œí¬ì¸íŠ¸ ì œì™¸ (ëŒ€ê¸°ì—´ ì°¸ì—¬ ë“±)
- OpenTelemetry íŠ¸ë ˆì´ì‹± í—¤ë” ìë™ ì „íŒŒ

### ë©±ë“±ì„± ê´€ë¦¬
```http
Idempotency-Key: <uuid-v4>
```
- POST/PUT/PATCH/DELETE í•„ìˆ˜ í—¤ë”
- ê²Œì´íŠ¸ì›¨ì´/ì˜ˆì•½ APIì—ì„œ ê²€ì¦
- Redis ê¸°ë°˜ ì €ì¥ (TTL: 5ë¶„)

### íƒ€ì„ì•„ì›ƒ ê°€ì´ë“œ
| í˜¸ì¶œ íŒ¨í„´ | ì œí•œ ì‹œê°„ | ëª©ì  |
|----------|----------|------|
| ê²Œì´íŠ¸ì›¨ì´ â†’ ë°±ì—”ë“œ | â‰¤ 600ms | ë¹ ë¥¸ ì‘ë‹µ ë³´ì¥ |
| ì˜ˆì•½ â†’ ì¬ê³ (gRPC) | â‰¤ 250ms | íŠ¸ëœì­ì…˜ ìµœì í™” |
| ì›¹í›… ì²˜ë¦¬ | â‰¤ 30s | ì™¸ë¶€ ì„œë¹„ìŠ¤ ëŒ€ì‘ |

### ì—ëŸ¬ ì‘ë‹µ í¬ë§·
```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "human readable message",
    "trace_id": "..."
  }
}
```

---

## 1. ğŸŒ API Gateway (REST)

### 1.1 ëŒ€ê¸°ì—´ ê´€ë¦¬ (Queue/Admission)

**ëŒ€ê¸°ì—´ ì°¸ì—¬**
```http
POST /api/v1/queue/join
Content-Type: application/json

{
  "event_id": "evt_2025_1001",
  "user_id": "u123"
}
```
```http
202 Accepted
{
  "waiting_token": "wtkn_abc123",
  "position_hint": 12345
}
```

**ëŒ€ê¸°ì—´ ìƒíƒœ ì¡°íšŒ**
```http
GET /api/v1/queue/status?token=wtkn_abc123
```
```http
200 OK
{
  "status": "waiting|ready|expired",
  "eta_sec": 42
}
```

**ì…ì¥ í—ˆê°€**
```http
POST /api/v1/queue/enter
Authorization: Bearer <JWT>  # ì„ íƒì 
Idempotency-Key: <uuid>
Content-Type: application/json

{
  "waiting_token": "wtkn_abc123"
}
```
```http
200 OK
{
  "admission": "granted",
  "reservation_token": "rtkn_xyz789",
  "ttl_sec": 30
}
```

### 1.2 ì˜ˆì•½ ê´€ë¦¬ (Reservation Proxy)

**ì˜ˆì•½ ìƒì„±**
```http
POST /api/v1/reservations
Authorization: Bearer <JWT>
Idempotency-Key: <uuid>
Content-Type: application/json

{
  "event_id": "evt_2025_1001",
  "seat_ids": ["A-12", "A-13"],
  "quantity": 2
}
```
```http
201 Created
{
  "reservation_id": "rsv_abc123",
  "hold_expires_at": "2024-01-01T12:05:00Z"
}
```

**ì˜ˆì•½ í™•ì •**
```http
POST /api/v1/reservations/rsv_abc123/confirm
Authorization: Bearer <JWT>
Idempotency-Key: <uuid>
```
```http
200 OK
{
  "order_id": "ord_xyz789",
  "status": "CONFIRMED"
}
```

**ì˜ˆì•½ ì·¨ì†Œ**
```http
POST /api/v1/reservations/rsv_abc123/cancel
Authorization: Bearer <JWT>
Idempotency-Key: <uuid>
```
```http
200 OK
{
  "status": "CANCELLED"
}
```

### 1.3 ê²°ì œ ê´€ë¦¬ (Payment Proxy)

**ê²°ì œ ì¸í…íŠ¸ ìƒì„±**
```http
POST /api/v1/payment/intent
Authorization: Bearer <JWT>
Idempotency-Key: <uuid>
Content-Type: application/json

{
  "reservation_id": "rsv_abc123",
  "amount": 120000,
  "currency": "KRW",
  "scenario": "approve|fail|delay"
}
```
```http
200 OK
{
  "payment_intent_id": "pay_xyz789",
  "next": "webhook"
}
```

### ì„±ëŠ¥ ëª©í‘œ
- **P95 ì§€ì—°ì‹œê°„**: < 50ms (ë°±ì—”ë“œ ì œì™¸)
- **429 ë¹„ìœ¨**: â‰¤ 1% (ëŒ€ê¸°ì—´ ì œì–´ ê¸°ë°˜)

---

## 2. ğŸ« Reservation API (Spring Boot)

### 2.1 ì˜ˆì•½ ë¼ì´í”„ì‚¬ì´í´

**ì˜ˆì•½ ìƒì„± (ë©±ë“±ì„±)**
```http
POST /v1/reservations
Authorization: Bearer <JWT>
Idempotency-Key: <uuid>
Content-Type: application/json

{
  "event_id": "evt_2025_1001",
  "seat_ids": ["A-12", "A-13"],
  "reservation_token": "rtkn_xyz789",
  "user_id": "u123"
}
```
```http
201 Created
{
  "reservation_id": "rsv_abc123",
  "hold_expires_at": "2024-01-01T12:05:00Z"
}
```

**ì˜ˆì•½ í™•ì •**
```http
POST /v1/reservations/rsv_abc123/confirm
Content-Type: application/json

{
  "payment_intent_id": "pay_xyz789"
}
```
```http
200 OK
{
  "order_id": "ord_xyz789",
  "status": "CONFIRMED"
}
```

**ì˜ˆì•½ ì·¨ì†Œ**
```http
POST /v1/reservations/rsv_abc123/cancel
```
```http
200 OK
{
  "status": "CANCELLED"
}
```

**ì˜ˆì•½ ì¡°íšŒ**
```http
GET /v1/reservations/rsv_abc123
```
```http
200 OK
{
  "reservation_id": "rsv_abc123",
  "status": "HOLD|CONFIRMED|CANCELLED",
  "hold_expires_at": "2024-01-01T12:05:00Z"
}
```

### ì„±ëŠ¥ ëª©í‘œ
- **P95 ì§€ì—°ì‹œê°„**: < 120ms (í™•ì • ì œì™¸)
- **ì—ëŸ¬ìœ¨**: < 1%

---

## 3. ğŸ­ Inventory Service (Go + gRPC)

### 3.1 gRPC ì¸í„°í˜ì´ìŠ¤ ì •ì˜

```protobuf
syntax = "proto3";
package inventory.v1;

service Inventory {
  rpc CheckAvailability(CheckReq) returns (CheckRes);
  rpc CommitReservation(CommitReq) returns (CommitRes);
  rpc ReleaseHold(ReleaseReq) returns (ReleaseRes);
}

message CheckReq {
  string event_id = 1;
  repeated string seat_ids = 2;
  int32 qty = 3;
}

message CheckRes {
  bool available = 1;
  repeated string unavailable_seats = 2;
}

message CommitReq {
  string reservation_id = 1;
  string event_id = 2;
  repeated string seat_ids = 3;
  int32 qty = 4;
  string payment_intent_id = 5;
}

message CommitRes {
  string order_id = 1;
  string status = 2;
}

message ReleaseReq {
  string reservation_id = 1;
  string event_id = 2;
  repeated string seat_ids = 3;
  int32 qty = 4;
}

message ReleaseRes {
  string status = 1;
}
```

### ì£¼ìš” íŠ¹ì§•
- **ì˜¤ë²„ì…€ ë°©ì§€**: DynamoDB ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸ + TransactWrite
- **íƒ€ì„ì•„ì›ƒ**: í´ë¼ì´ì–¸íŠ¸ deadline â‰¤ 250ms
- **ì¬ì‹œë„ ê¸ˆì§€**: ë©±ë“±ì„± ê¸°ë°˜ ì¬í˜¸ì¶œë¡œ í•´ê²°

### ì„±ëŠ¥ ëª©í‘œ
- **P95 ì§€ì—°ì‹œê°„**: < 40ms
- **ì˜¤ë¥˜ìœ¨**: < 0.5%

---

## 4. ğŸ’³ Payment Simulator (Node.js)

### 4.1 ê²°ì œ ì¸í…íŠ¸ ìƒì„±

```http
POST /v1/sim/intent
Content-Type: application/json

{
  "reservation_id": "rsv_abc123",
  "amount": 120000,
  "scenario": "approve|fail|delay"
}
```
```http
200 OK
{
  "payment_intent_id": "pay_xyz789",
  "status": "PENDING"
}
```

### 4.2 ê²°ì œ ì›¹í›…

```http
POST /v1/sim/webhook
X-Signature: sha256=<hmac>
Content-Type: application/json

{
  "type": "payment.approved|payment.failed",
  "reservation_id": "rsv_abc123",
  "payment_intent_id": "pay_xyz789",
  "ts": "2024-01-01T12:00:00Z"
}
```
```http
200 OK
{
  "received": true
}
```

---

## 5. âš™ï¸ Worker Service (Go + Events)

### 5.1 ì´ë²¤íŠ¸ ìŠ¤í‚¤ë§ˆ

```json
{
  "id": "evt_uuid_v4",
  "type": "reservation.hold.created|reservation.hold.expired|payment.approved|payment.failed",
  "source": "reservation-api|payment-sim",
  "detail": {
    "reservation_id": "rsv_abc123",
    "event_id": "evt_2025_1001",
    "qty": 2,
    "seat_ids": ["A-12", "A-13"],
    "payment_intent_id": "pay_xyz789"
  },
  "time": "2024-01-01T12:00:00Z",
  "trace_id": "..."
}
```

### ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¡œì§
- **reservation.hold.expired** â†’ `inventory-api.ReleaseHold()`
- **payment.approved** â†’ `inventory-api.CommitReservation()`
- **ë©±ë“±ì„± ë³´ì¥**: reservation_id ê¸°ë°˜ ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
- **ì‹ ë¢°ì„±**: DLQ + ìµœëŒ€ ì¬ì‹œë„ + ë°°ì¹˜ ì²˜ë¦¬

### ì„±ëŠ¥ ëª©í‘œ
- **ë°°ì¹˜ ì²˜ë¦¬ P95**: < 80ms
- **Lag ì•ˆì •í™”**: ì´ë²¤íŠ¸ ì²˜ë¦¬ ì§€ì—° ìµœì†Œí™”

---

## 6. ğŸ“Š ì½ê¸° ì „ìš© ì¡°íšŒ API (ì„ íƒ)

### ì´ë²¤íŠ¸ ê°€ìš©ì„± ì¡°íšŒ
```http
GET /api/v1/events/evt_2025_1001/availability
```
```http
200 OK
{
  "remaining": 1234,
  "sections": [
    {
      "id": "A",
      "remain": 120
    }
  ]
}
```

---

## ğŸ“Š ë°ì´í„° ëª¨ë¸ (DynamoDB)

### Reservations í…Œì´ë¸”
```javascript
// Primary Key
pk: reservation_id  // "rsv_abc123"
sk: event_id        // "evt_2025_1001"

// Attributes
user_id: "u123"
status: "HOLD|CONFIRMED|CANCELLED"
seat_ids: ["A-12", "A-13"]
quantity: 2
total_price: 50000
hold_expires_at: "2024-01-01T12:05:00Z"
idempotency_key: "uuid-v4"
created_at: "2024-01-01T12:00:00Z"
updated_at: "2024-01-01T12:00:00Z"
```

### Orders í…Œì´ë¸”
```javascript
// Primary Key
pk: order_id        // "ord_xyz789"
sk: reservation_id  // "rsv_abc123"

// Attributes
user_id: "u123"
event_id: "evt_2025_1001"
seat_ids: ["A-12", "A-13"]
total_amount: 50000
status: "CONFIRMED"
payment_intent_id: "pay_xyz789"
created_at: "2024-01-01T12:00:00Z"
```

### Inventory í…Œì´ë¸”
```javascript
// Primary Key
pk: event_id        // "evt_2025_1001"
sk: "metadata"      // íŒŒí‹°ì…˜ ë‚´ ì •ë ¬ í‚¤

// Attributes
total_seats: 10000
remaining_seats: 8500
version: 42  // ë‚™ê´€ì  ì ê¸ˆìš©
sections: {
  "A": { remaining: 120, total: 200 },
  "B": { remaining: 80, total: 150 }
}
last_updated: "2024-01-01T12:00:00Z"
```

---

## ğŸ”´ ì—ëŸ¬ ì½”ë“œ í‘œ

| ì½”ë“œ | HTTP | ì„¤ëª… |
|------|------|------|
| `UNAUTHENTICATED` | 401 | JWT ëˆ„ë½/ë§Œë£Œ |
| `FORBIDDEN` | 403 | ê¶Œí•œ ë¶€ì¡±/í—ˆìš© ì „ ì…ì¥ |
| `RATE_LIMITED` | 429 | ë ˆì´íŠ¸ ì´ˆê³¼ |
| `IDEMPOTENCY_REQUIRED` | 400 | ë©±ë“±ì„± í‚¤ ëˆ„ë½ |
| `IDEMPOTENCY_CONFLICT` | 409 | ë™ì¼ í‚¤ + ë‹¤ë¥¸ ìš”ì²­ |
| `RESERVATION_EXPIRED` | 409 | í™€ë“œ ë§Œë£Œ |
| `PAYMENT_NOT_APPROVED` | 412 | ê²°ì œ ìŠ¹ì¸ ì „ |
| `INVENTORY_CONFLICT` | 409 | ì¬ê³  ë¶€ì¡±/ì¶©ëŒ |
| `UPSTREAM_TIMEOUT` | 504 | ë°±ì—”ë“œ íƒ€ì„ì•„ì›ƒ |

---

## ğŸ“ˆ ì²˜ë¦¬ëŸ‰ ì œì–´ ê°€ì´ë“œ

### ë‹¨ê³„ë³„ ì²˜ë¦¬ëŸ‰ ê´€ë¦¬
1. **ìœ ì… (Join/Status)**: ìµœëŒ€ 30k RPS (CloudFront ìºì‹œ í™œìš©)
2. **ì…ì¥ (Enter)**: 1,000 RPSë¡œ ì œí•œ (Admission Worker)
3. **ì˜ˆì•½ ìƒì„±**: 500-1,500 RPS (í™˜ê²½ë³„ ì¡°ì •)
4. **ì˜ˆì•½ í™•ì •**: 300-800 RPS (DB íŠ¸ëœì­ì…˜ í•œê³„)

### Redis í‚¤ ì„¤ê³„
```javascript
// ì…ì¥ í—ˆìš© í† í°
allow:<event_id>:<waiting_token>  // TTL: 30ì´ˆ

// ë©±ë“±ì„± ì €ì¥
idempotency:<key>  // TTL: 5ë¶„

// ë ˆì´íŠ¸ ë¦¬ë¯¸íŒ…
ratelimit:<user_ip>  // TTL: 1ì´ˆ
```

---

*ì´ ë¬¸ì„œëŠ” ì„œë¹„ìŠ¤ ê°„ API ê³„ì•½ ë° ì¸í„°í˜ì´ìŠ¤ì˜ ê³µì‹ ì •ì˜ì…ë‹ˆë‹¤.*